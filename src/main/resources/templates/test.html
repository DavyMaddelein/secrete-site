
<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script src="http://d3js.org/d3.v3.min.js"></script>
</head>

<style>

    rect {
        fill: none;
        pointer-events: all;
    }

    .link {
        stroke: #999;
    }
    circle.node {
        stroke: #fff;
        stroke-width: 3.5px;
    }
    path {
        fill: #D3D3D3;
        stroke: white;
    }

    #tooltip1 {
        position: absolute;
        width: 100px;
        height: auto;
        padding: 10px;
        background-color: white;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        pointer-events: none;
    }

    #tooltip1.hidden {
        display: none;
    }

    #tooltip1 p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
    }

</style>
<body>

<div id="tooltip1" class="hidden">
    <p><span id="value"></span></p>
</div>
<div><img border="0" src="images/protein.png" width="86px" height="67px" /></div>

<script>

    var width = 960,
        height = 500;

    var dataNodes = [],
        dataLinks = [];
    var preNode = "";
    var text = '{ "nodes" : [' +
        '{ "name":"A" , "group":1 },' +
        '{ "name":"B" , "group":1 },' +
        '{ "name":"C" , "group":1 },' +
        '{ "name":"D" , "group":1 }],' +
        '"links" : [' +
        '{ "source":0 , "target":1 , "value":0.4 },' +
        '{ "source":0 , "target":2 , "value":0.4},' +
        '{ "source":0 , "target":3 , "value":0.4},' +
        '{ "source":1 , "target":2 , "value":0.4}] }' ;

    var data = JSON.parse(text);

    for (var i=0; i<data.nodes.length; ++i) {
        dataNodes.push(data.nodes[i]);
    }
    for (var i=0; i<data.links.length; ++i) {

        if (data.links[i].value >= 0.4) {dataLinks.push(data.links[i]);}
    }

    var force = d3.layout.force()
        .size([width, height])
        .nodes(dataNodes) // initialize with a single node
        .links(dataLinks)
        .linkDistance(100)
        .charge(-60)
        .on("tick", tick);

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)

    svg.append("rect")
        .attr("width", width)
        .attr("height", height);


    var
        node = svg.selectAll(".node"),
        link = svg.selectAll(".link");

    restart();



    function clicked(d, i) {

        var newNode = '{ "name":"E" , "group":2 }';
        dataNodes.push(JSON.parse(newNode));
        var newLink = '{ "source":' +i+ ', "target":' +(dataNodes.length-1)+ ', "value":0.4}';
        dataLinks.push(JSON.parse(newLink));
        restart();
    }

    function tick() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
    }

    function restart() {

        var drag = force.drag()
            .on("dragstart", dragstart);


        node = node.data(dataNodes);

        node.enter().append("circle")
            .attr("class", "node")
            .attr("r",function (d) {
                if(d.group == 1){
                    return "15";
                }else{
                    return "10";
                }})
            .style("fill", function (d) {
                if(d.group == 1){
                    return "#22aa99";
                }else{
                    return "darkorange";
                }
            })
            .on("click", appendRingToNode)
            .on("mouseover", function(d) {

                //Update the tooltip position and value
                d3.select("#tooltip1")
                    .select("#value")
                    .text(d.name);

                //Show the tooltip
                d3.select("#tooltip1").classed("hidden", false);

            })
            .on("mouseout", function() {

                //Hide the tooltip
                d3.select("#tooltip1").classed("hidden", true);

            })
            .call(drag);

        svg.selectAll(".node").append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text("hdjhgjfh");

        node.exit()
            .remove();

        link = link.data(dataLinks);

        link.enter().insert("line", ".node")
            .attr("class", "link");
        link.exit()
            .remove();

        force.start();
    }

    function dragstart(d) {
        d3.select(this).classed("fixed", d.fixed = true);
    }


    function appendRingToNode(node) {
        var path = svg.selectAll("path");
        if(path != ""){
            path.remove();
            svg.selectAll("g.slice").remove();
        }
        if(preNode != node){
            var datapie = [
                {"label":"expand", "value":1, "icon": "\uF055", "message":"Expand the child nodes"},
                {"label":"info", "value":1, "icon": "\uF05A", "message":"Click here for more information about the protein"},
                {"label":"collapse", "value":1, "icon": "\uF056", "message":"Collapse the child nodes"}
            ];


            var vis = svg.data([datapie]).attr("width", width).attr("height", height).append("svg:g").attr("transform", "translate(" + node.x + "," + node.y + ")");
            var pie = d3.layout.pie().value(function(d){return d.value;});

            // declare an arc generator function
            var arc = d3.svg.arc().outerRadius(40).innerRadius(17);

            // select paths, use arc generator to draw
            var arcs = vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class", "slice");
            arcs.append("svg:path")
                .attr("d", function (d) {
                    return arc(d);
                });


            // add the image
            arcs.append('text')
                .attr("transform", function(d){
                    return "translate(" + arc.centroid(d)[0] + ", "+ (arc.centroid(d)[1]+7)+ ")";
                })
                .attr('text-anchor', 'middle')
                .attr('font-family', 'FontAwesome')
                .attr('font-size', function(d) { return 20+'px'} )
                .text(function(d) { return  d.data.icon })
                .style("fill", "gray");
            arcs
                .on("mouseover", function(d) {

                    //Update the tooltip position and value
                    d3.select("#tooltip1")
                        .select("#value")
                        .text(d.data.message);

                    //Show the tooltip
                     d3.select("#tooltip1").classed("hidden", false);

                })
                .on("mouseout", function() {

                    //Hide the tooltip
                    d3.select("#tooltip1").classed("hidden", true);

                })
                .on("click",function(d) {

                    if(d.data.label == "expand"){
                        clicked(node, node.index);
                    }

                })
            preNode = node;
        }else{
            preNode = "";
        }

    }








</script>
