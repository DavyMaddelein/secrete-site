<!DOCTYPE html>
<meta charset="utf-8">
<style>

    .link {
        stroke: #ccc;
    }

    .node text {
        pointer-events: none;
        font: 10px sans-serif;
    }

    path {
        fill: #D3D3D3;
        stroke: white;
    }

    image{
        fill : black;
    }

</style>
<body></body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

    var width = 960,
        height = 500

    var preNode = "";
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    var force = d3.layout.force()
        .linkDistance(100)
        .charge(-60)
        .size([width, height]);
    var text = '{ "nodes" : [' +
        '{ "name":"A" , "group":1 },' +
        '{ "name":"B" , "group":1 },' +
        '{ "name":"C" , "group":1 },' +
        '{ "name":"D" , "group":1 }],' +
        '"links" : [' +
        '{ "source":0 , "target":1 , "value":0.4 },' +
        '{ "source":0 , "target":2 , "value":0.4},' +
        '{ "source":0 , "target":3 , "value":0.4},' +
        '{ "source":1 , "target":2 , "value":0.4}] }' ;

    var data = JSON.parse(text);
    var dataNodes = [],
        dataLinks = [];

    for (var i=0; i<data.nodes.length; ++i) {
        dataNodes.push(data.nodes[i]);
    }
    for (var i=0; i<data.links.length; ++i) {

        if (data.links[i].value >= 0.4) {dataLinks.push(data.links[i]);}
    }

        force
            .nodes(dataNodes)
            .links(dataLinks)
            .start();

        var link = svg.selectAll(".link")
            .data(dataLinks)
            .enter().append("line")
            .attr("class", "link");

        var node = svg.selectAll(".node")
            .data(dataNodes)
            .enter().append("g")
            .attr("class", "node")
            .on("dblclick", clicked)
            .on("click", appendRingToNode)
            .call(force.drag);

        node.append("image")
            .attr("xlink:href", "https://github.com/favicon.ico")
            .attr("x", -8)
            .attr("y", -8)
            .attr("width", 16)
            .attr("height", 16);

        node.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(function(d) { return d.name });

        force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        });

        function restart(){
            link = svg.selectAll(".link").data(dataLinks)
                .enter().append("line")
                .attr("class", "link");

            node = svg.selectAll(".node").data(dataNodes)
                .enter().append("g")
                .attr("class", "node")
                .on("dblclick", clicked)
                .on("click", appendRingToNode)
                .call(force.drag);

            node.append("image")
                .attr("xlink:href", "https://github.com/favicon.ico")
                .attr("x", -8)
                .attr("y", -8)
                .attr("width", 16)
                .attr("height", 16);

            node.append("text")
                .attr("dx", 12)
                .attr("dy", ".35em")
                .text(function(d) { return d.name });

            force.start();
        }

    function clicked(d, i) {
        var newNode = '{ "name":"E" , "group":2 }';
        dataNodes.push(JSON.parse(newNode));
        var newLink = '{ "source":' +i+ ', "target":' +(dataNodes.length-1)+ ', "value":0.4}';
        dataLinks.push(JSON.parse(newLink));
        restart();
    }

    function appendRingToNode(node) {

        var datapie = [
            {"label":"Category A", "value":20, "icon": "http://files.gamebanana.com/img/ico/sprays/4f68c8d10306a.png"},
            {"label":"Category B", "value":50, "icon": "http://files.gamebanana.com/img/ico/sprays/4f69c5f09c7bf.png"},
            {"label":"Category C", "value":30, "icon": "http://files.gamebanana.com/img/ico/sprays/4ecb328ca104a.png"}
        ];


        var vis = svg.data([datapie]).attr("width", width).attr("height", height).append("svg:g").attr("transform", "translate(" + node.x + "," + node.y + ")");
        var pie = d3.layout.pie().value(function(d){return d.value;});

// declare an arc generator function
        var arc = d3.svg.arc().outerRadius(30).innerRadius(17);

// select paths, use arc generator to draw
        var arcs = vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class", "slice");
        arcs.append("svg:path")
            .attr("fill", function(d, i){
                return "gray";
            })
            .attr("d", function (d) {
                // log the result of the arc generator to show how cool it is :)
                console.log(arc(d));
                return arc(d);
            });


        // add the image
        arcs.append("svg:image").attr("transform", function(d){
            var x = arc.centroid(d)[0] - 3;
            var y = arc.centroid(d)[1] - 3;
            return "translate(" + x + "," + y + ")";
        })
            .attr("xlink:href",function(d) { console.log(d); return d.data.icon;})
            .attr("width", 10)
            .attr("height", 10);
    }

    function appendRingToNodex(node) {

        var path = svg.selectAll("path");

        if(path != ""){
            path.remove();
        }
        if(preNode != node){
            var arc1 = d3.svg.arc()
                .innerRadius(17)
                .outerRadius(40)
                .startAngle(0)
                .endAngle(Math.PI *2/3);
            var arc2 = d3.svg.arc()
                .innerRadius(17)
                .outerRadius(40)
                .startAngle(Math.PI *2/3)
                .endAngle(Math.PI *4/3);
            var arc3 = d3.svg.arc()
                .innerRadius(17)
                .outerRadius(40)
                .startAngle(Math.PI *4/3)
                .endAngle(Math.PI *2);
            var groupforpath = svg.append("g");
            path1 =groupforpath.append("path")
                .attr("d", arc1)
                .attr("transform", "translate(" +node.x + ","+node.y+")")
                .on("mouseover", function(d) {

                    //Update the tooltip position and value
                    d3.select("#tooltip1")
                        .select("#value")
                        .text("something");

                    //Show the tooltip
                    d3.select("#tooltip1").classed("hidden", false);

                })
                .on("mouseout", function() {

                    //Hide the tooltip
                    d3.select("#tooltip1").classed("hidden", true);

                });
            groupforpath.append('image')
                .attr('src', 'images/protein.png')
                .attr('height', '15')
                .attr('width', '15')
                .attr("transform", "translate(" +node.x + ","+node.y+")");

            groupforpath.append("path")
                .attr("d", arc2)
                .attr("transform", "translate(" +node.x + ","+node.y+")");
            groupforpath.append("path")
                .attr("d", arc3)
                .attr("transform", "translate(" +node.x + ","+node.y+")");

            preNode = node;
        }else{
            preNode = "";
        }
    }


</script>
